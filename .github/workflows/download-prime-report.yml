name: Download Prime Report

on:
  schedule:
    # Run every Monday at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download Prime Report
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials. Please set PRIME_EMPRESA, PRIME_USUARIO, and PRIME_SENHA secrets.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox']
            });

            const page = await browser.newPage();

            // Set download behavior
            const downloadPath = path.resolve('./downloads');
            if (!fs.existsSync(downloadPath)) {
              fs.mkdirSync(downloadPath, { recursive: true });
            }

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Go to login page
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);

              // Step 2: Fill login form
              console.log('Step 2: Filling login form...');

              // Find and fill Empresa Cliente field
              await page.waitForSelector('input[type="text"]', { timeout: 10000 });
              const inputs = await page.$$('input[type="text"], input[type="password"]');

              // Usually: first input = empresa, second = usuario, third = senha
              if (inputs.length >= 2) {
                await inputs[0].click({ clickCount: 3 });
                await inputs[0].type(PRIME_EMPRESA);
                await sleep(500);

                await inputs[1].click({ clickCount: 3 });
                await inputs[1].type(PRIME_USUARIO);
                await sleep(500);
              }

              // Find password field
              const passwordInput = await page.$('input[type="password"]');
              if (passwordInput) {
                await passwordInput.click({ clickCount: 3 });
                await passwordInput.type(PRIME_SENHA);
                await sleep(500);
              }

              // Step 3: Click login button
              console.log('Step 3: Clicking login button...');
              const loginButton = await page.$('button, input[type="submit"], [class*="acessar"], [id*="acessar"]');
              if (loginButton) {
                await loginButton.click();
              } else {
                // Try to find button by text
                await page.evaluate(() => {
                  const buttons = Array.from(document.querySelectorAll('button, input[type="button"], input[type="submit"]'));
                  const loginBtn = buttons.find(b => b.textContent.includes('Acessar') || b.value === 'Acessar');
                  if (loginBtn) loginBtn.click();
                });
              }

              await page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 });
              await sleep(3000);
              console.log('Logged in successfully. Current URL:', page.url());

              // Step 4: Click on CONSULTA menu
              console.log('Step 4: Clicking on CONSULTA menu...');
              await page.waitForSelector('a, span, div', { timeout: 10000 });
              await page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('a, span, div, li'));
                const consulta = elements.find(el => el.textContent.trim() === 'CONSULTA');
                if (consulta) consulta.click();
              });
              await sleep(2000);

              // Step 5: Click on Estabelecimentos
              console.log('Step 5: Clicking on Estabelecimentos...');
              await page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('a, span, div, li'));
                const estab = elements.find(el => el.textContent.trim() === 'Estabelecimentos');
                if (estab) estab.click();
              });
              await sleep(3000);

              // Step 6: Expand Filtros if collapsed
              console.log('Step 6: Expanding Filtros...');
              await page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('a, span, div, h3, h4, button'));
                const filtros = elements.find(el => el.textContent.includes('Filtros'));
                if (filtros) filtros.click();
              });
              await sleep(2000);

              // Step 7: Select filters
              console.log('Step 7: Selecting filters...');

              // Select UF = SP
              await page.evaluate(() => {
                const selects = Array.from(document.querySelectorAll('select'));
                const ufSelect = selects.find(s => {
                  const label = s.closest('div')?.querySelector('label');
                  return label?.textContent.includes('UF') || s.id.toLowerCase().includes('uf') || s.name?.toLowerCase().includes('uf');
                });
                if (ufSelect) {
                  ufSelect.value = 'SP';
                  ufSelect.dispatchEvent(new Event('change', { bubbles: true }));
                }
              });
              await sleep(1500);

              // Select Cidade = GUARULHOS
              await page.evaluate(() => {
                const selects = Array.from(document.querySelectorAll('select'));
                const cidadeSelect = selects.find(s => {
                  const label = s.closest('div')?.querySelector('label');
                  return label?.textContent.includes('Cidade') || s.id.toLowerCase().includes('cidade') || s.name?.toLowerCase().includes('cidade');
                });
                if (cidadeSelect) {
                  const option = Array.from(cidadeSelect.options).find(o => o.text.toUpperCase().includes('GUARULHOS'));
                  if (option) {
                    cidadeSelect.value = option.value;
                    cidadeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                  }
                }
              });
              await sleep(1500);

              // Select Tipo Estabelecimento = POSTO
              await page.evaluate(() => {
                const selects = Array.from(document.querySelectorAll('select'));
                const tipoSelect = selects.find(s => {
                  const label = s.closest('div')?.querySelector('label');
                  return label?.textContent.includes('Tipo') || s.id.toLowerCase().includes('tipo') || s.name?.toLowerCase().includes('tipo');
                });
                if (tipoSelect) {
                  const option = Array.from(tipoSelect.options).find(o => o.text.toUpperCase().includes('POSTO'));
                  if (option) {
                    tipoSelect.value = option.value;
                    tipoSelect.dispatchEvent(new Event('change', { bubbles: true }));
                  }
                }
              });
              await sleep(1500);

              // Step 8: Click Buscar button
              console.log('Step 8: Clicking Buscar button...');
              await page.evaluate(() => {
                const buttons = Array.from(document.querySelectorAll('button, input[type="button"], input[type="submit"], a'));
                const buscar = buttons.find(b => b.textContent.includes('Buscar') || b.value?.includes('Buscar'));
                if (buscar) buscar.click();
              });
              await sleep(5000);

              // Step 9: Click Ações dropdown
              console.log('Step 9: Opening Ações dropdown...');
              await page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('button, a, span, div'));
                const acoes = elements.find(el => el.textContent.includes('Ações'));
                if (acoes) acoes.click();
              });
              await sleep(1500);

              // Step 10: Click PDF option
              console.log('Step 10: Clicking PDF option...');
              await page.evaluate(() => {
                const elements = Array.from(document.querySelectorAll('a, button, span, li'));
                const pdf = elements.find(el => el.textContent.trim() === 'PDF' || el.textContent.includes('PDF'));
                if (pdf) pdf.click();
              });

              // Wait for download
              console.log('Waiting for download to complete...');
              await sleep(30000);

              // Check if file was downloaded
              const files = fs.readdirSync(downloadPath);
              console.log('Files in download folder:', files);

              if (files.length > 0) {
                // Find the PDF file
                const pdfFile = files.find(f => f.endsWith('.pdf'));
                if (pdfFile) {
                  const oldPath = path.join(downloadPath, pdfFile);
                  const newPath = './prime-report.pdf';
                  fs.copyFileSync(oldPath, newPath);
                  console.log('PDF saved as prime-report.pdf');
                } else {
                  console.log('No PDF file found, saving first file...');
                  const oldPath = path.join(downloadPath, files[0]);
                  const newPath = './prime-report.pdf';
                  fs.copyFileSync(oldPath, newPath);
                }
              } else {
                console.error('No files were downloaded');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              // Take screenshot for debugging
              await page.screenshot({ path: 'error-screenshot.png', fullPage: true });
              console.log('Screenshot saved as error-screenshot.png');
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal error:', err);
            process.exit(1);
          });
          EOF

      - name: Commit and push report
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add prime-report.pdf || true
          git add error-screenshot.png || true
          git diff --staged --quiet || git commit -m "Update Prime report [automated]"
          git push

name: Download Prime Report

on:
  schedule:
    - cron: '0 10 * * 1'
  workflow_dispatch:

jobs:
  download-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download Prime Report
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1920, height: 1080 });

            const downloadPath = path.resolve('./downloads');
            fs.mkdirSync(downloadPath, { recursive: true });

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Login
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);
              await page.screenshot({ path: 'step1-login.png', fullPage: true });

              // Step 2: Fill form
              console.log('Step 2: Filling login form...');
              await page.waitForSelector('#cliente');
              await page.type('#cliente', PRIME_EMPRESA, { delay: 30 });
              await page.type('#login', PRIME_USUARIO, { delay: 30 });
              await page.type('#pass', PRIME_SENHA, { delay: 30 });
              await page.screenshot({ path: 'step2-filled.png', fullPage: true });

              // Step 3: Submit login
              console.log('Step 3: Submitting login...');
              await Promise.all([
                page.click('#submit-form'),
                page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 }).catch(() => {})
              ]);
              await sleep(5000);
              console.log('URL after login:', page.url());
              await page.screenshot({ path: 'step3-logged.png', fullPage: true });

              // Step 4: Navigate directly to the iframe content (SubMenuConsulta.aspx)
              // The menu is inside an iframe, so we navigate directly to its URL
              console.log('Step 4: Navigating to SubMenuConsulta (iframe content)...');
              await page.goto('https://sistema.primebeneficios.com.br/Admin/Novos/Menus/SubMenuConsulta.aspx?visualiza=N', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(3000);
              console.log('URL after CONSULTA:', page.url());
              await page.screenshot({ path: 'step4-consulta.png', fullPage: true });

              // Debug: List all elements on the submenu page
              const menuElements = await page.evaluate(() => {
                const results = [];
                const allElements = document.querySelectorAll('a, li, span, div');
                for (const el of allElements) {
                  const text = el.textContent.trim();
                  if (text.length > 0 && text.length < 50) {
                    results.push({
                      tag: el.tagName,
                      text: text,
                      href: el.href || null,
                      id: el.id || null
                    });
                  }
                }
                return results.slice(0, 50);
              });
              console.log('Menu elements found:', JSON.stringify(menuElements, null, 2));

              // Step 5: Click Estabelecimentos in the submenu
              console.log('Step 5: Clicking Estabelecimentos...');

              // Find and click element containing "Estabelecimentos"
              const estabClicked = await page.evaluate(() => {
                const allElements = document.querySelectorAll('a, li, span, div');
                for (const el of allElements) {
                  const text = el.textContent.trim();
                  if (text === 'Estabelecimentos') {
                    el.click();
                    return { clicked: true, tag: el.tagName, href: el.href || null };
                  }
                }
                return { clicked: false };
              });
              console.log('Estabelecimentos click result:', JSON.stringify(estabClicked));

              await sleep(3000);
              await page.screenshot({ path: 'step5-estabelecimentos.png', fullPage: true });
              console.log('URL after Estabelecimentos click:', page.url());

              // Debug: List elements after clicking Estabelecimentos
              const afterEstabElements = await page.evaluate(() => {
                const results = [];
                const allElements = document.querySelectorAll('a, li, span');
                for (const el of allElements) {
                  const text = el.textContent.trim();
                  if (text.length > 0 && text.length < 30) {
                    results.push({ tag: el.tagName, text: text, href: el.href || null });
                  }
                }
                return results.slice(0, 30);
              });
              console.log('Elements after Estabelecimentos click:', JSON.stringify(afterEstabElements, null, 2));

              // Step 6: Click Lista
              console.log('Step 6: Looking for Lista...');

              const listaClicked = await page.evaluate(() => {
                const allElements = document.querySelectorAll('a, li, span');
                for (const el of allElements) {
                  if (el.textContent.trim() === 'Lista') {
                    el.click();
                    return { clicked: true, tag: el.tagName, href: el.href || null };
                  }
                }
                return { clicked: false };
              });
              console.log('Lista click result:', JSON.stringify(listaClicked));

              await sleep(3000);
              console.log('URL after Lista click:', page.url());
              await page.screenshot({ path: 'step6-lista.png', fullPage: true });

              // Debug: List all selects to verify we're on the right page
              const selectsAfterLista = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                return Array.from(selects).map((s, i) => ({
                  index: i,
                  id: s.id,
                  name: s.name,
                  optionsCount: s.options.length
                }));
              });
              console.log('Selects on current page:', JSON.stringify(selectsAfterLista));

              // Step 7: Expand Filtros
              console.log('Step 7: Expanding Filtros...');
              await page.evaluate(() => {
                const elements = document.querySelectorAll('*');
                for (const el of elements) {
                  if (el.textContent.includes('Filtros') && el.textContent.length < 30) {
                    el.click();
                    break;
                  }
                }
              });
              await sleep(2000);
              await page.screenshot({ path: 'step7-filtros.png', fullPage: true });

              // Debug: Log all selects
              const allSelects = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                return Array.from(selects).map((s, i) => ({
                  index: i,
                  id: s.id,
                  name: s.name,
                  optionsCount: s.options.length,
                  firstOptions: Array.from(s.options).slice(0, 5).map(o => o.text)
                }));
              });
              console.log('Selects found:', JSON.stringify(allSelects, null, 2));

              // Step 8: Select filters
              console.log('Step 8: Selecting filters...');

              // Select UF = SP
              const ufResult = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.value === 'SP' || opt.text === 'SP') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'SP selected in ' + (sel.id || sel.name);
                    }
                  }
                }
                return 'SP not found';
              });
              console.log('UF:', ufResult);
              await sleep(3000);

              // Select Cidade = GUARULHOS
              const cidadeResult = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase().includes('GUARULHOS')) {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'GUARULHOS selected';
                    }
                  }
                }
                return 'GUARULHOS not found';
              });
              console.log('Cidade:', cidadeResult);
              await sleep(2000);

              // Select Tipo = POSTO
              const tipoResult = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase() === 'POSTO') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'POSTO selected';
                    }
                  }
                }
                return 'POSTO not found';
              });
              console.log('Tipo:', tipoResult);
              await sleep(2000);
              await page.screenshot({ path: 'step8-filters.png', fullPage: true });

              // Step 9: Click Buscar
              console.log('Step 9: Clicking Buscar...');
              const buscarResult = await page.evaluate(() => {
                const elements = document.querySelectorAll('button, a, input');
                for (const el of elements) {
                  const text = el.textContent || el.value || '';
                  if (text.includes('Buscar')) {
                    el.click();
                    return 'Buscar clicked';
                  }
                }
                return 'Buscar not found';
              });
              console.log('Buscar:', buscarResult);
              await sleep(10000);
              await page.screenshot({ path: 'step9-buscar.png', fullPage: true });

              // Step 10: Click Ações
              console.log('Step 10: Opening Ações...');
              const acoesResult = await page.evaluate(() => {
                const elements = document.querySelectorAll('button, a, span, div');
                for (const el of elements) {
                  if (el.textContent.trim().startsWith('Ações')) {
                    el.click();
                    return 'Ações clicked';
                  }
                }
                return 'Ações not found';
              });
              console.log('Ações:', acoesResult);
              await sleep(2000);
              await page.screenshot({ path: 'step10-acoes.png', fullPage: true });

              // Step 11: Click PDF
              console.log('Step 11: Clicking PDF...');
              const pdfResult = await page.evaluate(() => {
                const elements = document.querySelectorAll('a, button, li, span');
                for (const el of elements) {
                  const text = el.textContent.trim();
                  if (text === 'PDF' || (text.includes('PDF') && text.length < 10)) {
                    el.click();
                    return 'PDF clicked';
                  }
                }
                return 'PDF not found';
              });
              console.log('PDF:', pdfResult);
              await sleep(60000);
              await page.screenshot({ path: 'step11-final.png', fullPage: true });

              // Check downloads
              const files = fs.readdirSync(downloadPath);
              console.log('Downloaded files:', files);

              if (files.length > 0) {
                const file = files.find(f => f.endsWith('.pdf')) || files[0];
                fs.copyFileSync(path.join(downloadPath, file), './prime-report.pdf');
                console.log('Saved as prime-report.pdf');
              } else {
                console.error('No files downloaded');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal:', err);
            process.exit(1);
          });
          EOF

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: '*.png'
          retention-days: 7

      - name: Commit report
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add prime-report.pdf || true
          git diff --staged --quiet || git commit -m "Update Prime report [automated]"
          git push

name: Download Prime Report

on:
  schedule:
    # Run every Monday at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download Prime Report
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1920, height: 1080 });

            const downloadPath = path.resolve('./downloads');
            fs.mkdirSync(downloadPath, { recursive: true });

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Login
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);
              await page.screenshot({ path: 'step1-login.png', fullPage: true });

              // Step 2: Fill form
              console.log('Step 2: Filling login form...');
              await page.waitForSelector('#cliente');
              await page.type('#cliente', PRIME_EMPRESA, { delay: 30 });
              await page.type('#login', PRIME_USUARIO, { delay: 30 });
              await page.type('#pass', PRIME_SENHA, { delay: 30 });
              await page.screenshot({ path: 'step2-filled.png', fullPage: true });

              // Step 3: Submit login
              console.log('Step 3: Submitting login...');
              await Promise.all([
                page.click('#submit-form'),
                page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 }).catch(() => {})
              ]);
              await sleep(5000);
              console.log('URL after login:', page.url());
              await page.screenshot({ path: 'step3-logged.png', fullPage: true });

              // Step 4: Navigate directly to Estabelecimentos page
              console.log('Step 4: Navigating to Estabelecimentos...');

              // Try different possible URLs for the Estabelecimentos page
              const possibleUrls = [
                'https://sistema.primebeneficios.com.br/Admin/Consulta/Estabelecimentos/Lista.aspx',
                'https://sistema.primebeneficios.com.br/Admin/Consulta/Estabelecimentos.aspx',
                'https://sistema.primebeneficios.com.br/Admin/Estabelecimentos.aspx'
              ];

              let navigated = false;
              for (const url of possibleUrls) {
                try {
                  console.log('Trying URL:', url);
                  await page.goto(url, { waitUntil: 'networkidle2', timeout: 30000 });
                  await sleep(2000);

                  // Check if we're on the right page (has Filtros or UF dropdown)
                  const hasFilters = await page.evaluate(() => {
                    return document.body.innerHTML.includes('Filtros') ||
                           document.body.innerHTML.includes('UF') ||
                           document.querySelector('select') !== null;
                  });

                  if (hasFilters) {
                    console.log('Found Estabelecimentos page at:', url);
                    navigated = true;
                    break;
                  }
                } catch (e) {
                  console.log('URL failed:', url, e.message);
                }
              }

              await page.screenshot({ path: 'step4-estabelecimentos.png', fullPage: true });

              // Step 5: Try clicking menu if direct URL didn't work
              if (!navigated) {
                console.log('Step 5: Trying menu navigation...');

                // Click CONSULTA
                await page.evaluate(() => {
                  const menuItems = document.querySelectorAll('a, li, span');
                  for (const item of menuItems) {
                    if (item.textContent.trim().toUpperCase() === 'CONSULTA') {
                      item.click();
                      break;
                    }
                  }
                });
                await sleep(2000);

                // Click Estabelecimentos
                await page.evaluate(() => {
                  const menuItems = document.querySelectorAll('a, li, span');
                  for (const item of menuItems) {
                    if (item.textContent.trim() === 'Estabelecimentos') {
                      item.click();
                      break;
                    }
                  }
                });
                await sleep(2000);

                // Click Lista
                await page.evaluate(() => {
                  const menuItems = document.querySelectorAll('a, li, span');
                  for (const item of menuItems) {
                    if (item.textContent.trim() === 'Lista') {
                      item.click();
                      break;
                    }
                  }
                });
                await sleep(3000);
              }

              await page.screenshot({ path: 'step5-navigation.png', fullPage: true });

              // Step 6: Expand Filtros if needed
              console.log('Step 6: Expanding Filtros...');
              await page.evaluate(() => {
                const filtros = Array.from(document.querySelectorAll('*')).find(el =>
                  el.textContent.includes('Filtros') && el.textContent.length < 50
                );
                if (filtros) filtros.click();
              });
              await sleep(2000);
              await page.screenshot({ path: 'step6-filtros.png', fullPage: true });

              // Step 7: Select UF = SP
              console.log('Step 7: Selecting UF = SP...');
              const ufSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.value === 'SP' || opt.text === 'SP') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return true;
                    }
                  }
                }
                return false;
              });
              console.log('UF selected:', ufSelected);
              await sleep(3000);

              // Step 8: Select Cidade = GUARULHOS
              console.log('Step 8: Selecting Cidade = GUARULHOS...');
              const cidadeSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase().includes('GUARULHOS')) {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return true;
                    }
                  }
                }
                return false;
              });
              console.log('Cidade selected:', cidadeSelected);
              await sleep(2000);

              // Step 9: Select Tipo = POSTO
              console.log('Step 9: Selecting Tipo = POSTO...');
              const tipoSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase() === 'POSTO') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return true;
                    }
                  }
                }
                return false;
              });
              console.log('Tipo selected:', tipoSelected);
              await sleep(2000);
              await page.screenshot({ path: 'step9-filters.png', fullPage: true });

              // Step 10: Click Buscar
              console.log('Step 10: Clicking Buscar...');
              await page.evaluate(() => {
                const btns = document.querySelectorAll('button, input, a');
                for (const btn of btns) {
                  const text = (btn.textContent || btn.value || '').trim();
                  if (text.includes('Buscar')) {
                    btn.click();
                    return true;
                  }
                }
                return false;
              });
              await sleep(10000);
              await page.screenshot({ path: 'step10-buscar.png', fullPage: true });

              // Step 11: Click Ações
              console.log('Step 11: Opening Ações...');
              await page.evaluate(() => {
                const elements = document.querySelectorAll('button, a, span, div');
                for (const el of elements) {
                  if (el.textContent.trim() === 'Ações' || el.textContent.trim().startsWith('Ações')) {
                    el.click();
                    return true;
                  }
                }
                return false;
              });
              await sleep(2000);
              await page.screenshot({ path: 'step11-acoes.png', fullPage: true });

              // Step 12: Click PDF
              console.log('Step 12: Clicking PDF...');
              await page.evaluate(() => {
                const elements = document.querySelectorAll('a, button, li, span');
                for (const el of elements) {
                  if (el.textContent.trim() === 'PDF') {
                    el.click();
                    return true;
                  }
                }
                return false;
              });

              console.log('Waiting for download...');
              await sleep(60000);
              await page.screenshot({ path: 'step12-final.png', fullPage: true });

              // Check downloads
              const files = fs.readdirSync(downloadPath);
              console.log('Downloaded files:', files);

              if (files.length > 0) {
                const file = files.find(f => f.endsWith('.pdf')) || files[0];
                fs.copyFileSync(path.join(downloadPath, file), './prime-report.pdf');
                console.log('Saved as prime-report.pdf');
              } else {
                console.error('No files downloaded');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal:', err);
            process.exit(1);
          });
          EOF

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: '*.png'
          retention-days: 7

      - name: Commit report
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add prime-report.pdf || true
          git diff --staged --quiet || git commit -m "Update Prime report [automated]"
          git push

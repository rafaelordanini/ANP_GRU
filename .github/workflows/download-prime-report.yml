name: Download Prime Report

on:
  schedule:
    # Run every Monday at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * 1'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Download Prime Report
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          // Click element using XPath
          async function clickXPath(page, xpath) {
            const elements = await page.$x(xpath);
            if (elements.length > 0) {
              await elements[0].click();
              console.log('Clicked XPath:', xpath);
              return true;
            }
            console.log('XPath not found:', xpath);
            return false;
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1920, height: 1080 });

            const downloadPath = path.resolve('./downloads');
            fs.mkdirSync(downloadPath, { recursive: true });

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Login
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);
              await page.screenshot({ path: 'step1-login.png', fullPage: true });

              // Step 2: Fill form
              console.log('Step 2: Filling login form...');
              await page.waitForSelector('#cliente');
              await page.type('#cliente', PRIME_EMPRESA, { delay: 30 });
              await page.type('#login', PRIME_USUARIO, { delay: 30 });
              await page.type('#pass', PRIME_SENHA, { delay: 30 });
              await page.screenshot({ path: 'step2-filled.png', fullPage: true });

              // Step 3: Submit login
              console.log('Step 3: Submitting login...');
              await Promise.all([
                page.click('#submit-form'),
                page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 }).catch(() => {})
              ]);
              await sleep(5000);
              console.log('URL after login:', page.url());
              await page.screenshot({ path: 'step3-logged.png', fullPage: true });

              // Step 4: Click CONSULTA menu (using XPath for exact text match)
              console.log('Step 4: Clicking CONSULTA menu...');

              // Try multiple methods to click CONSULTA
              let consultaClicked = await clickXPath(page, "//a[normalize-space(text())='CONSULTA']");

              if (!consultaClicked) {
                consultaClicked = await clickXPath(page, "//span[normalize-space(text())='CONSULTA']");
              }

              if (!consultaClicked) {
                consultaClicked = await clickXPath(page, "//*[contains(@class, 'menu')]//*[contains(text(), 'CONSULTA')]");
              }

              if (!consultaClicked) {
                // Try using page.evaluate with href
                consultaClicked = await page.evaluate(() => {
                  const links = document.querySelectorAll('a');
                  for (const link of links) {
                    if (link.textContent.trim().toUpperCase() === 'CONSULTA' ||
                        link.href.toLowerCase().includes('consulta')) {
                      link.click();
                      return true;
                    }
                  }
                  return false;
                });
              }

              console.log('CONSULTA clicked:', consultaClicked);
              await sleep(3000);
              await page.screenshot({ path: 'step4-consulta.png', fullPage: true });

              // Step 5: Click Estabelecimentos
              console.log('Step 5: Clicking Estabelecimentos...');

              let estabClicked = await clickXPath(page, "//a[normalize-space(text())='Estabelecimentos']");

              if (!estabClicked) {
                estabClicked = await page.evaluate(() => {
                  const links = document.querySelectorAll('a');
                  for (const link of links) {
                    if (link.textContent.trim() === 'Estabelecimentos' ||
                        link.href.toLowerCase().includes('estabelecimento')) {
                      link.click();
                      return true;
                    }
                  }
                  return false;
                });
              }

              console.log('Estabelecimentos clicked:', estabClicked);
              await sleep(3000);
              await page.screenshot({ path: 'step5-estabelecimentos.png', fullPage: true });

              // Step 6: Click Lista tab
              console.log('Step 6: Clicking Lista...');

              let listaClicked = await clickXPath(page, "//a[normalize-space(text())='Lista']");

              if (!listaClicked) {
                listaClicked = await page.evaluate(() => {
                  const links = document.querySelectorAll('a');
                  for (const link of links) {
                    if (link.textContent.trim() === 'Lista') {
                      link.click();
                      return true;
                    }
                  }
                  return false;
                });
              }

              console.log('Lista clicked:', listaClicked);
              await sleep(3000);
              await page.screenshot({ path: 'step6-lista.png', fullPage: true });

              // Step 7: Expand Filtros
              console.log('Step 7: Expanding Filtros...');
              await clickXPath(page, "//*[contains(text(), 'Filtros')]");
              await sleep(2000);
              await page.screenshot({ path: 'step7-filtros.png', fullPage: true });

              // Step 8: Select filters
              console.log('Step 8: Selecting filters...');

              // Select UF = SP
              const ufSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.value === 'SP' || opt.text === 'SP') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'SP selected';
                    }
                  }
                }
                return 'SP not found';
              });
              console.log('UF:', ufSelected);
              await sleep(3000);

              // Select Cidade = GUARULHOS
              const cidadeSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase().includes('GUARULHOS')) {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'GUARULHOS selected';
                    }
                  }
                }
                return 'GUARULHOS not found';
              });
              console.log('Cidade:', cidadeSelected);
              await sleep(2000);

              // Select Tipo = POSTO
              const tipoSelected = await page.evaluate(() => {
                const selects = document.querySelectorAll('select');
                for (const sel of selects) {
                  for (const opt of sel.options) {
                    if (opt.text.toUpperCase() === 'POSTO') {
                      sel.value = opt.value;
                      sel.dispatchEvent(new Event('change', { bubbles: true }));
                      return 'POSTO selected';
                    }
                  }
                }
                return 'POSTO not found';
              });
              console.log('Tipo:', tipoSelected);
              await sleep(2000);
              await page.screenshot({ path: 'step8-filters.png', fullPage: true });

              // Step 9: Click Buscar
              console.log('Step 9: Clicking Buscar...');

              let buscarClicked = await clickXPath(page, "//button[contains(text(), 'Buscar')]");
              if (!buscarClicked) {
                buscarClicked = await clickXPath(page, "//a[contains(text(), 'Buscar')]");
              }
              if (!buscarClicked) {
                buscarClicked = await clickXPath(page, "//input[@value='Buscar']");
              }

              console.log('Buscar clicked:', buscarClicked);
              await sleep(10000);
              await page.screenshot({ path: 'step9-buscar.png', fullPage: true });

              // Step 10: Click Ações dropdown
              console.log('Step 10: Opening Ações...');

              let acoesClicked = await clickXPath(page, "//button[contains(text(), 'Ações')]");
              if (!acoesClicked) {
                acoesClicked = await clickXPath(page, "//a[contains(text(), 'Ações')]");
              }
              if (!acoesClicked) {
                acoesClicked = await clickXPath(page, "//*[contains(text(), 'Ações')]");
              }

              console.log('Ações clicked:', acoesClicked);
              await sleep(2000);
              await page.screenshot({ path: 'step10-acoes.png', fullPage: true });

              // Step 11: Click PDF
              console.log('Step 11: Clicking PDF...');

              let pdfClicked = await clickXPath(page, "//a[normalize-space(text())='PDF']");
              if (!pdfClicked) {
                pdfClicked = await clickXPath(page, "//li[contains(text(), 'PDF')]");
              }
              if (!pdfClicked) {
                pdfClicked = await clickXPath(page, "//*[contains(text(), 'PDF')]");
              }

              console.log('PDF clicked:', pdfClicked);
              await sleep(60000);
              await page.screenshot({ path: 'step11-final.png', fullPage: true });

              // Check downloads
              const files = fs.readdirSync(downloadPath);
              console.log('Downloaded files:', files);

              if (files.length > 0) {
                const file = files.find(f => f.endsWith('.pdf')) || files[0];
                fs.copyFileSync(path.join(downloadPath, file), './prime-report.pdf');
                console.log('Saved as prime-report.pdf');
              } else {
                console.error('No files downloaded');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal:', err);
            process.exit(1);
          });
          EOF

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots
          path: '*.png'
          retention-days: 7

      - name: Commit report
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add prime-report.pdf || true
          git diff --staged --quiet || git commit -m "Update Prime report [automated]"
          git push

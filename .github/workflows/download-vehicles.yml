name: Download Vehicles Data

on:
  schedule:
    # Run every day at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-vehicles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch vehicles from Prime API
        env:
          PRIME_CODIGO: ${{ secrets.PRIME_CODIGO }}
          PRIME_KEY: ${{ secrets.PRIME_KEY }}
        run: |
          # Validate credentials
          if [ -z "$PRIME_CODIGO" ] || [ -z "$PRIME_KEY" ]; then
            echo "Error: PRIME_CODIGO or PRIME_KEY secrets are not set"
            exit 1
          fi

          echo "Fetching data from Prime API..."

          # Call the API to get all fueling data (status=1 for active)
          API_URL="https://ws.sisatec.com.br/api/abastecimento/${PRIME_CODIGO}/${PRIME_KEY}/1"

          echo "API URL: https://ws.sisatec.com.br/api/abastecimento/${PRIME_CODIGO}/****/1"

          # Fetch data from API
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" "$API_URL")
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$HTTP_RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"

          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: API returned status $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi

          # Check for API error message
          if echo "$RESPONSE_BODY" | grep -q '"Message":"nao autorizado"'; then
            echo "Error: API authentication failed - check PRIME_CODIGO and PRIME_KEY"
            exit 1
          fi

          # Save raw response for debugging
          echo "$RESPONSE_BODY" > api_response.json
          echo "API response saved to api_response.json"

          # Process the response with Node.js to extract unique vehicles with latest km
          node << 'EOF'
          const fs = require('fs');

          try {
            const data = JSON.parse(fs.readFileSync('api_response.json', 'utf8'));

            // Handle both array and object with abastecimentos property
            let abastecimentos = [];
            if (Array.isArray(data)) {
              abastecimentos = data;
            } else if (data.abastecimentos && Array.isArray(data.abastecimentos)) {
              abastecimentos = data.abastecimentos;
            } else {
              console.log('Unexpected API response format:', Object.keys(data));
              // Try to use the data directly if it has the expected fields
              if (data.placa && data.kmAtual !== undefined) {
                abastecimentos = [data];
              }
            }

            console.log(`Found ${abastecimentos.length} fueling records`);

            // Group by placa and get the latest km for each vehicle
            const vehicleMap = new Map();

            abastecimentos.forEach(record => {
              const placa = record.placa ? record.placa.toString().trim().toUpperCase() : null;
              const kmAtual = record.kmAtual ? parseInt(record.kmAtual.toString().replace(/[^\d]/g, '')) : 0;
              const data = record.data || '';
              const hora = record.hora || '';

              if (!placa) return;

              // Parse date (format: dd/MM/yyyy)
              let recordDate = new Date(0);
              if (data) {
                const parts = data.split('/');
                if (parts.length === 3) {
                  recordDate = new Date(parts[2], parts[1] - 1, parts[0]);
                  if (hora) {
                    const timeParts = hora.split(':');
                    if (timeParts.length >= 2) {
                      recordDate.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]));
                    }
                  }
                }
              }

              const existing = vehicleMap.get(placa);
              if (!existing || recordDate > existing.date) {
                vehicleMap.set(placa, {
                  placa: placa,
                  km: kmAtual,
                  date: recordDate,
                  lastFueling: data
                });
              }
            });

            // Convert to array and sort by placa
            const vehicles = Array.from(vehicleMap.values())
              .map(v => ({ placa: v.placa, km: v.km }))
              .sort((a, b) => a.placa.localeCompare(b.placa));

            console.log(`Extracted ${vehicles.length} unique vehicles`);

            // Sample of vehicles for logging
            if (vehicles.length > 0) {
              console.log('Sample vehicles:');
              vehicles.slice(0, 5).forEach(v => {
                console.log(`  ${v.placa}: ${v.km.toLocaleString()} km`);
              });
              if (vehicles.length > 5) {
                console.log(`  ... and ${vehicles.length - 5} more`);
              }
            }

            const result = {
              success: true,
              vehicles: vehicles,
              updatedAt: new Date().toISOString()
            };

            fs.writeFileSync('vehicles.json', JSON.stringify(result, null, 2));
            console.log('Saved to vehicles.json');

          } catch (error) {
            console.error('Error processing API response:', error.message);

            // Try to show a snippet of the response for debugging
            try {
              const raw = fs.readFileSync('api_response.json', 'utf8');
              console.log('Raw response (first 500 chars):', raw.substring(0, 500));
            } catch (e) {}

            process.exit(1);
          }
          EOF

      - name: Commit vehicles data
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vehicles.json || true
          git diff --staged --quiet || git commit -m "Update vehicles data [automated]"
          git push

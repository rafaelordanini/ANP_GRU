name: Download Vehicles Data

on:
  schedule:
    # Run every day at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-vehicles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install puppeteer xlsx

      - name: Download Vehicles XLS
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1920, height: 1080 });

            const downloadPath = path.resolve('./downloads');
            fs.mkdirSync(downloadPath, { recursive: true });

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Login
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);

              // Step 2: Fill form
              console.log('Step 2: Filling login form...');
              await page.waitForSelector('#cliente');
              await page.type('#cliente', PRIME_EMPRESA, { delay: 30 });
              await page.type('#login', PRIME_USUARIO, { delay: 30 });
              await page.type('#pass', PRIME_SENHA, { delay: 30 });

              // Step 3: Submit login
              console.log('Step 3: Submitting login...');
              await Promise.all([
                page.click('#submit-form'),
                page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 }).catch(() => {})
              ]);
              await sleep(5000);
              console.log('URL after login:', page.url());
              await page.screenshot({ path: 'step3-after-login.png', fullPage: true });

              // Step 4: Wait for iframe to load and get the main frame
              console.log('Step 4: Looking for iframe...');
              await sleep(3000);

              // The admin panel uses an iframe structure. We need to find and work with it.
              const frames = page.frames();
              console.log('Found frames:', frames.length);
              frames.forEach((f, i) => console.log(`Frame ${i}: ${f.url()}`));

              // Try to find the content iframe
              let contentFrame = null;
              for (const frame of frames) {
                const url = frame.url();
                if (url.includes('Admin') && !url.includes('Admin.aspx')) {
                  contentFrame = frame;
                  console.log('Found content frame:', url);
                  break;
                }
              }

              // If no content frame found, try navigating directly within the current context
              // by executing JavaScript in the page context
              console.log('Step 5: Navigating to Veiculos page via menu...');

              // Try clicking menu through JavaScript
              const menuClicked = await page.evaluate(() => {
                // Try to find and click CONSULTA menu
                const menuItems = document.querySelectorAll('a, li');
                for (const item of menuItems) {
                  if (item.textContent && item.textContent.trim().toUpperCase().includes('CONSULTA')) {
                    item.click();
                    return { found: 'CONSULTA', clicked: true };
                  }
                }

                // Try in iframes
                const iframes = document.querySelectorAll('iframe');
                for (const iframe of iframes) {
                  try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const items = iframeDoc.querySelectorAll('a, li');
                    for (const item of items) {
                      if (item.textContent && item.textContent.trim().toUpperCase().includes('CONSULTA')) {
                        item.click();
                        return { found: 'CONSULTA in iframe', clicked: true };
                      }
                    }
                  } catch(e) {
                    // cross-origin
                  }
                }
                return { found: false };
              });
              console.log('Menu click result:', JSON.stringify(menuClicked));
              await sleep(2000);
              await page.screenshot({ path: 'step5-after-menu.png', fullPage: true });

              // Step 6: Click on Veículos submenu
              console.log('Step 6: Looking for Veículos submenu...');
              const veiculosClicked = await page.evaluate(() => {
                const findAndClick = (doc) => {
                  const items = doc.querySelectorAll('a, li, span');
                  for (const item of items) {
                    const text = item.textContent ? item.textContent.trim().toUpperCase() : '';
                    if (text === 'VEÍCULOS' || text === 'VEICULOS') {
                      item.click();
                      return true;
                    }
                  }
                  return false;
                };

                if (findAndClick(document)) return { found: 'main doc', clicked: true };

                const iframes = document.querySelectorAll('iframe');
                for (const iframe of iframes) {
                  try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    if (findAndClick(iframeDoc)) return { found: 'iframe', clicked: true };
                  } catch(e) {}
                }
                return { found: false };
              });
              console.log('Veículos click result:', JSON.stringify(veiculosClicked));
              await sleep(3000);
              await page.screenshot({ path: 'step6-after-veiculos.png', fullPage: true });

              // Step 7: Navigate directly to Consulta_Veiculos.aspx within the iframe
              console.log('Step 7: Trying direct navigation within iframe context...');

              // Get all frames again after navigation
              await sleep(2000);
              const allFrames = page.frames();
              console.log('Current frames:', allFrames.length);

              let targetFrame = page.mainFrame();
              for (const frame of allFrames) {
                const url = frame.url();
                console.log('Checking frame:', url);
                if (url.includes('sistema.primebeneficios.com.br')) {
                  targetFrame = frame;
                  console.log('Using frame:', url);
                  break;
                }
              }

              // Try navigating using __doPostBack which is how ASP.NET navigation works
              console.log('Step 8: Attempting __doPostBack navigation...');
              const postbackResult = await targetFrame.evaluate(() => {
                // Try to find the menu and trigger navigation
                if (typeof __doPostBack === 'function') {
                  // Common ASP.NET postback targets for menu items
                  const possibleTargets = [
                    'ctl00$MenuLateral1$rptMenu$ctl02$rptSubMenu$ctl01$lnkSubItem',
                    'ctl00$MenuLateral1$rptMenu$ctl01$rptSubMenu$ctl00$lnkSubItem',
                    'MenuLateral1$rptMenu$ctl02$rptSubMenu$ctl01$lnkSubItem'
                  ];

                  for (const target of possibleTargets) {
                    try {
                      __doPostBack(target, '');
                      return { method: 'postback', target: target, success: true };
                    } catch(e) {
                      // continue
                    }
                  }
                }

                // Try direct link navigation
                const links = document.querySelectorAll('a[href*="Veiculos"], a[href*="veiculos"]');
                if (links.length > 0) {
                  links[0].click();
                  return { method: 'link', success: true };
                }

                return { success: false };
              }).catch(e => ({ error: e.message }));
              console.log('Postback result:', JSON.stringify(postbackResult));
              await sleep(3000);
              await page.screenshot({ path: 'step8-after-postback.png', fullPage: true });

              // Step 9: Try navigating the iframe directly to the vehicles page
              console.log('Step 9: Navigating iframe to Consulta_Veiculos.aspx...');

              // Find the main content iframe
              const iframeHandle = await page.$('iframe[name="main"], iframe[id="main"], iframe');
              if (iframeHandle) {
                console.log('Found iframe element');
                const frame = await iframeHandle.contentFrame();
                if (frame) {
                  console.log('Got iframe content frame');
                  try {
                    await frame.goto('https://sistema.primebeneficios.com.br/Admin/Consulta_Veiculos.aspx', {
                      waitUntil: 'networkidle2',
                      timeout: 30000
                    });
                    console.log('Navigated iframe to Veiculos page');
                    await sleep(3000);
                    await page.screenshot({ path: 'step9-veiculos-page.png', fullPage: true });

                    // Now try to download XLS from within the iframe
                    console.log('Step 10: Looking for Ações button in iframe...');
                    const acoesResult = await frame.evaluate(() => {
                      const buttons = document.querySelectorAll('button');
                      for (const btn of buttons) {
                        if (btn.textContent.trim() === 'Ações') {
                          btn.click();
                          return { found: true, clicked: true };
                        }
                      }
                      return { found: false };
                    });
                    console.log('Ações result:', JSON.stringify(acoesResult));
                    await sleep(1000);
                    await page.screenshot({ path: 'step10-acoes.png', fullPage: true });

                    // Click XLS download
                    console.log('Step 11: Clicking XLS download...');
                    const xlsResult = await frame.evaluate(() => {
                      // Try by ID
                      const xlsLink = document.getElementById('download_txt');
                      if (xlsLink) {
                        xlsLink.click();
                        return { method: 'id', success: true };
                      }

                      // Try by text
                      const links = document.querySelectorAll('a');
                      for (const link of links) {
                        if (link.textContent.trim().toUpperCase() === 'XLS') {
                          link.click();
                          return { method: 'text', success: true };
                        }
                      }

                      // Try postback
                      if (typeof __doPostBack === 'function') {
                        __doPostBack('download_txt', '');
                        return { method: 'postback', success: true };
                      }

                      return { success: false };
                    });
                    console.log('XLS result:', JSON.stringify(xlsResult));
                    await page.screenshot({ path: 'step11-xls.png', fullPage: true });
                  } catch (navError) {
                    console.log('Iframe navigation error:', navError.message);
                  }
                }
              }

              // Step 12: Wait for download
              console.log('Step 12: Waiting for download...');
              let downloadComplete = false;
              let attempts = 0;
              const maxAttempts = 30;

              while (!downloadComplete && attempts < maxAttempts) {
                await sleep(5000);
                attempts++;

                const files = fs.readdirSync(downloadPath);
                console.log(`Attempt ${attempts}: Files in download folder:`, files);

                const completedFiles = files.filter(f =>
                  !f.endsWith('.crdownload') &&
                  !f.endsWith('.tmp') &&
                  !f.startsWith('.')
                );

                if (completedFiles.length > 0) {
                  console.log('Download completed! Files:', completedFiles);
                  downloadComplete = true;

                  const xlsFile = completedFiles.find(f =>
                    f.toLowerCase().endsWith('.xls') ||
                    f.toLowerCase().endsWith('.xlsx')
                  ) || completedFiles[0];
                  const xlsPath = path.join(downloadPath, xlsFile);

                  // Parse XLS and extract vehicle data
                  console.log('Parsing XLS file:', xlsFile);
                  const workbook = XLSX.readFile(xlsPath);
                  const sheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[sheetName];

                  // Convert to JSON starting from row 5 (index 4) which has headers
                  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    range: 4,
                    defval: null
                  });

                  // Extract Placa and Km
                  const vehicles = [];
                  jsonData.forEach(row => {
                    const placa = row['Placa'] || row['PLACA'];
                    const km = row['Km/Hodômetro'] || row['KM/HODÔMETRO'] || row['Km'] || row['KM'];

                    if (placa && placa.toString().trim()) {
                      vehicles.push({
                        placa: placa.toString().trim().toUpperCase(),
                        km: km !== null && !isNaN(km) ? parseInt(km) : 0
                      });
                    }
                  });

                  console.log(`Found ${vehicles.length} vehicles`);

                  const result = {
                    success: true,
                    vehicles: vehicles,
                    updatedAt: new Date().toISOString()
                  };

                  fs.writeFileSync('vehicles.json', JSON.stringify(result, null, 2));
                  console.log('Saved to vehicles.json');
                }
              }

              await page.screenshot({ path: 'step12-final.png', fullPage: true });

              if (!downloadComplete) {
                console.log('Download folder contents:', fs.readdirSync(downloadPath));
                console.error('Download did not complete within timeout');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal:', err);
            process.exit(1);
          });
          EOF

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vehicles-debug-screenshots
          path: '*.png'
          retention-days: 7

      - name: Commit vehicles data
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vehicles.json || true
          git diff --staged --quiet || git commit -m "Update vehicles data [automated]"
          git push

name: Update Fuel Prices

on:
  schedule:
    # Run every day at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-prices:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install xlsx

      - name: Fetch and process ANP data
        run: |
          node << 'EOF'
          const XLSX = require('xlsx');
          const fs = require('fs');
          const https = require('https');
          const http = require('http');

          const ANP_PAGE_URL = 'https://www.gov.br/anp/pt-br/assuntos/precos-e-defesa-da-concorrencia/precos/precos-revenda-e-de-distribuicao-combustiveis/serie-historica-do-levantamento-de-precos';
          const HEADER_ROW = 11;

          function fetchUrl(url) {
            return new Promise((resolve, reject) => {
              const protocol = url.startsWith('https') ? https : http;
              const options = {
                headers: {
                  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
              };

              protocol.get(url, options, (res) => {
                if (res.statusCode >= 300 && res.statusCode < 400 && res.headers.location) {
                  fetchUrl(res.headers.location).then(resolve).catch(reject);
                  return;
                }

                const chunks = [];
                res.on('data', chunk => chunks.push(chunk));
                res.on('end', () => resolve(Buffer.concat(chunks)));
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          function excelDateToJS(serial) {
            if (serial instanceof Date) {
              // xlsx com cellDates:true pode ter problema de timezone
              // Adiciona 1 dia para compensar
              const corrected = new Date(serial.getTime() + 24 * 60 * 60 * 1000);
              return corrected;
            }
            if (typeof serial === 'string') {
              const parts = serial.split(/[-\/]/);
              if (parts.length === 3) {
                if (parts[0].length === 4) {
                  return new Date(Date.UTC(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0));
                } else {
                  return new Date(Date.UTC(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]), 12, 0, 0));
                }
              }
              return new Date(serial);
            }
            // Excel serial date - adiciona 1 para compensar
            const utcDays = serial - 25569 + 1;
            return new Date(Date.UTC(1970, 0, utcDays, 12, 0, 0));
          }

          function formatDate(date) {
            if (date instanceof Date) {
              const year = date.getUTCFullYear();
              const month = String(date.getUTCMonth() + 1).padStart(2, '0');
              const day = String(date.getUTCDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            return null;
          }

          async function findLatestExcelUrl() {
  console.log('Fetching ANP page...');
  const html = (await fetchUrl(ANP_PAGE_URL)).toString();

  const matches = [];
  
  // Pattern for files with year range (e.g., 2024-2025)
  const rangePattern = /semanal-municipio-(\d{4})-(\d{4})\.xlsx/gi;
  let match;
  while ((match = rangePattern.exec(html)) !== null) {
    matches.push({
      filename: match[0],
      startYear: parseInt(match[1]),
      endYear: parseInt(match[2])
    });
  }

  // Pattern for files with single year (e.g., 2026)
  const singlePattern = /semanal-municipio-(\d{4})\.xlsx/gi;
  while ((match = singlePattern.exec(html)) !== null) {
    // Avoid matching files already captured by range pattern
    if (!matches.some(m => m.filename === match[0])) {
      matches.push({
        filename: match[0],
        startYear: parseInt(match[1]),
        endYear: parseInt(match[1]) // Same year for start and end
      });
    }
  }

  if (matches.length === 0) {
    throw new Error('No municipality Excel files found');
  }

  // Remove duplicates and sort by end year (descending), then start year (descending)
  const unique = [...new Map(matches.map(m => [m.filename, m])).values()];
  unique.sort((a, b) => b.endYear - a.endYear || b.startYear - a.startYear);

  const latest = unique[0];
  const url = `https://www.gov.br/anp/pt-br/assuntos/precos-e-defesa-da-concorrencia/precos/precos-revenda-e-de-distribuicao-combustiveis/shlp/semanal/${latest.filename}`;

  console.log('Latest file:', latest.filename);
  return url;
}

          async function main() {
            try {
              const excelUrl = await findLatestExcelUrl();
              console.log('Downloading Excel from:', excelUrl);

              const data = await fetchUrl(excelUrl);
              console.log('Downloaded', data.length, 'bytes');

              const workbook = XLSX.read(data, { type: 'buffer', cellDates: true });
              const worksheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: HEADER_ROW, defval: null });

              const guarulhosData = jsonData.filter(row => {
                const municipio = row['MUNICÍPIO'] || row['MUNICIPIO'];
                return municipio && municipio.toString().toUpperCase() === 'GUARULHOS';
              });

              if (guarulhosData.length === 0) {
                throw new Error('No data found for Guarulhos');
              }

              let maxDate = null;
              guarulhosData.forEach(row => {
                const dataFinal = excelDateToJS(row['DATA FINAL']);
                if (!maxDate || dataFinal > maxDate) maxDate = dataFinal;
              });

              const latestData = guarulhosData.filter(row => {
                return excelDateToJS(row['DATA FINAL']).getTime() === maxDate.getTime();
              });

              let minDate = null;
              latestData.forEach(row => {
                const dataInicial = excelDateToJS(row['DATA INICIAL']);
                if (!minDate || dataInicial < minDate) minDate = dataInicial;
              });

              const prices = { gasolinaComum: null, etanol: null, diesel: null, gnv: null };

              latestData.forEach(row => {
                const produto = (row['PRODUTO'] || '').toString().toUpperCase();
                const preco = row['PREÇO MÉDIO REVENDA'];

                if (produto.includes('GASOLINA COMUM')) {
                  prices.gasolinaComum = preco !== null && !isNaN(preco) ? parseFloat(preco) : null;
                } else if (produto.includes('ETANOL')) {
                  prices.etanol = preco !== null && !isNaN(preco) ? parseFloat(preco) : null;
                } else if (produto.includes('DIESEL') && !produto.includes('S10')) {
                  prices.diesel = preco !== null && !isNaN(preco) ? parseFloat(preco) : null;
                } else if (produto.includes('GNV')) {
                  prices.gnv = preco !== null && !isNaN(preco) ? parseFloat(preco) : null;
                }
              });

              const result = {
                success: true,
                data: prices,
                periodStart: formatDate(minDate),
                periodEnd: formatDate(maxDate),
                sourceUrl: excelUrl,
                updatedAt: new Date().toISOString()
              };

              console.log('Result:', JSON.stringify(result, null, 2));

              fs.writeFileSync('prices.json', JSON.stringify(result, null, 2));
              console.log('Saved to prices.json');

            } catch (error) {
              console.error('Error:', error.message);
              process.exit(1);
            }
          }

          main();
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add prices.json
          git diff --staged --quiet || git commit -m "Update fuel prices [automated]"
          git push

name: Download Vehicles Data

on:
  schedule:
    # Run every day at 10:00 UTC (07:00 BRT)
    - cron: '0 10 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  download-vehicles:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install puppeteer xlsx

      - name: Download Vehicles XLS
        env:
          PRIME_EMPRESA: ${{ secrets.PRIME_EMPRESA }}
          PRIME_USUARIO: ${{ secrets.PRIME_USUARIO }}
          PRIME_SENHA: ${{ secrets.PRIME_SENHA }}
        run: |
          node << 'EOF'
          const puppeteer = require('puppeteer');
          const XLSX = require('xlsx');
          const fs = require('fs');
          const path = require('path');

          const PRIME_EMPRESA = process.env.PRIME_EMPRESA;
          const PRIME_USUARIO = process.env.PRIME_USUARIO;
          const PRIME_SENHA = process.env.PRIME_SENHA;

          if (!PRIME_EMPRESA || !PRIME_USUARIO || !PRIME_SENHA) {
            console.error('Missing credentials.');
            process.exit(1);
          }

          async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
          }

          async function main() {
            console.log('Starting browser...');
            const browser = await puppeteer.launch({
              headless: 'new',
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });

            const page = await browser.newPage();
            await page.setViewport({ width: 1920, height: 1080 });

            const downloadPath = path.resolve('./downloads');
            fs.mkdirSync(downloadPath, { recursive: true });

            const client = await page.createCDPSession();
            await client.send('Page.setDownloadBehavior', {
              behavior: 'allow',
              downloadPath: downloadPath
            });

            try {
              // Step 1: Login
              console.log('Step 1: Navigating to login page...');
              await page.goto('https://primebeneficios.com.br/Intranet/Frota', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(2000);

              // Step 2: Fill form
              console.log('Step 2: Filling login form...');
              await page.waitForSelector('#cliente');
              await page.type('#cliente', PRIME_EMPRESA, { delay: 30 });
              await page.type('#login', PRIME_USUARIO, { delay: 30 });
              await page.type('#pass', PRIME_SENHA, { delay: 30 });

              // Step 3: Submit login
              console.log('Step 3: Submitting login...');
              await Promise.all([
                page.click('#submit-form'),
                page.waitForNavigation({ waitUntil: 'networkidle2', timeout: 60000 }).catch(() => {})
              ]);
              await sleep(5000);
              console.log('URL after login:', page.url());

              // Step 4: Navigate directly to Consulta_Veiculos.aspx (Veículos page)
              console.log('Step 4: Navigating to Consulta_Veiculos.aspx...');
              await page.goto('https://sistema.primebeneficios.com.br/Admin/Consulta_Veiculos.aspx', {
                waitUntil: 'networkidle2',
                timeout: 60000
              });
              await sleep(3000);
              console.log('URL after navigation:', page.url());
              await page.screenshot({ path: 'step4-veiculos.png', fullPage: true });

              // Step 5: Open Ações dropdown and click XLS
              console.log('Step 5: Opening Ações dropdown...');
              const acoesClicked = await page.evaluate(() => {
                const buttons = document.querySelectorAll('button');
                for (const btn of buttons) {
                  if (btn.textContent.trim() === 'Ações') {
                    btn.click();
                    return true;
                  }
                }
                return false;
              });
              console.log('Ações clicked:', acoesClicked);
              await sleep(1000);
              await page.screenshot({ path: 'step5-acoes-open.png', fullPage: true });

              // Step 6: Click XLS download
              console.log('Step 6: Clicking XLS download...');
              const xlsClicked = await page.evaluate(() => {
                // Try clicking by ID first (download_txt for XLS)
                const xlsLink = document.getElementById('download_txt');
                if (xlsLink) {
                  xlsLink.click();
                  return { method: 'id', success: true };
                }

                // Try looking for a link with "XLS" text
                const links = document.querySelectorAll('a');
                for (const link of links) {
                  if (link.textContent.trim().toUpperCase() === 'XLS') {
                    link.click();
                    return { method: 'text', success: true };
                  }
                }

                // Fallback: use postback directly
                if (typeof __doPostBack === 'function') {
                  __doPostBack('download_txt', '');
                  return { method: 'postback', success: true };
                }

                return { success: false };
              });
              console.log('XLS click result:', JSON.stringify(xlsClicked));
              await page.screenshot({ path: 'step6-xls-clicked.png', fullPage: true });

              // Wait for download
              console.log('Waiting for download...');
              let downloadComplete = false;
              let attempts = 0;
              const maxAttempts = 30;

              while (!downloadComplete && attempts < maxAttempts) {
                await sleep(5000);
                attempts++;

                const files = fs.readdirSync(downloadPath);
                console.log(`Attempt ${attempts}: Files in download folder:`, files);

                const completedFiles = files.filter(f =>
                  !f.endsWith('.crdownload') &&
                  !f.endsWith('.tmp') &&
                  !f.startsWith('.')
                );

                if (completedFiles.length > 0) {
                  console.log('Download completed! Files:', completedFiles);
                  downloadComplete = true;

                  const xlsFile = completedFiles.find(f => f.toLowerCase().endsWith('.xls') || f.toLowerCase().endsWith('.xlsx')) || completedFiles[0];
                  const xlsPath = path.join(downloadPath, xlsFile);

                  // Parse XLS and extract vehicle data
                  console.log('Parsing XLS file:', xlsFile);
                  const workbook = XLSX.readFile(xlsPath);
                  const sheetName = workbook.SheetNames[0];
                  const worksheet = workbook.Sheets[sheetName];

                  // Convert to JSON starting from row 5 (index 4) which has headers
                  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    range: 4,
                    defval: null
                  });

                  // Extract Placa and Km
                  const vehicles = [];
                  jsonData.forEach(row => {
                    const placa = row['Placa'] || row['PLACA'];
                    const km = row['Km/Hodômetro'] || row['KM/HODÔMETRO'] || row['Km'] || row['KM'];

                    if (placa && placa.toString().trim()) {
                      vehicles.push({
                        placa: placa.toString().trim().toUpperCase(),
                        km: km !== null && !isNaN(km) ? parseInt(km) : 0
                      });
                    }
                  });

                  console.log(`Found ${vehicles.length} vehicles`);

                  // Load existing revisions.json if exists
                  let revisions = {};
                  try {
                    if (fs.existsSync('revisions.json')) {
                      revisions = JSON.parse(fs.readFileSync('revisions.json', 'utf8'));
                    }
                  } catch (e) {
                    console.log('No existing revisions.json or error reading it');
                  }

                  const result = {
                    success: true,
                    vehicles: vehicles,
                    updatedAt: new Date().toISOString()
                  };

                  fs.writeFileSync('vehicles.json', JSON.stringify(result, null, 2));
                  console.log('Saved to vehicles.json');
                }
              }

              await page.screenshot({ path: 'step7-final.png', fullPage: true });

              if (!downloadComplete) {
                console.log('Download folder contents:', fs.readdirSync(downloadPath));
                console.error('Download did not complete within timeout');
                process.exit(1);
              }

            } catch (error) {
              console.error('Error:', error.message);
              await page.screenshot({ path: 'error.png', fullPage: true });
              throw error;
            } finally {
              await browser.close();
            }
          }

          main().catch(err => {
            console.error('Fatal:', err);
            process.exit(1);
          });
          EOF

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vehicles-debug-screenshots
          path: '*.png'
          retention-days: 7

      - name: Commit vehicles data
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add vehicles.json || true
          git diff --staged --quiet || git commit -m "Update vehicles data [automated]"
          git push
